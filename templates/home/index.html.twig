{% extends 'base.html.twig' %}

{% block title %}Tableau de bord{% endblock %}

{% block body %}
<h1 class="et-page-title">Tableau de bord</h1>

<div class="et-stats">
    <div class="et-stat-card">
        <div class="et-stat-label">Total du mois</div>
        <div class="et-stat-value">{{ total_mois|number_format(0, ',', ' ') }} <small>unités</small></div>
    </div>
    <div class="et-stat-card">
        <div class="et-stat-label">Coût total du mois</div>
        <div class="et-stat-value">{{ cout_total_mois|number_format(2, ',', ' ') }} <small>€</small></div>
    </div>
    <div class="et-stat-card">
        <div class="et-stat-label">Objectifs atteints</div>
        <div class="et-stat-value">{{ objectifs_atteints }}</div>
    </div>
    <div class="et-stat-card">
        <div class="et-stat-label">Objectifs en cours</div>
        <div class="et-stat-value">{{ objectifs_en_cours }}</div>
    </div>
    <div class="et-stat-card">
        <div class="et-stat-label">Objectifs dépassés</div>
        <div class="et-stat-value">{{ objectifs_depasses }}</div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="et-card">
            <div class="et-card-header">Consommations par type (ce mois)</div>
            <ul class="et-list-group">
                {% for id, data in par_type %}
                    <li class="et-list-item">
                        <span>{{ data.type_energie }} — {{ data.total|number_format(0, ',', ' ') }} unités</span>
                        <strong>{{ data.cout|number_format(2, ',', ' ') }} €</strong>
                    </li>
                {% else %}
                    <li class="et-list-empty">Aucune donnée ce mois.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="et-card">
            <div class="et-card-header">Derniers objectifs</div>
            <ul class="et-list-group">
                {% for row in objectifs %}
                    <li class="et-list-item">
                        <span>{{ row.objectif.typeEnergie ? row.objectif.typeEnergie.libelle : '—' }} — {{ row.objectif.valeurCible }} ({{ row.objectif.periode }}) — consommé : {{ row.consommation_totale|number_format(0, ',', ' ') }}</span>
                        {% if row.atteint %}
                            <span class="et-badge et-badge-success">Atteint</span>
                        {% else %}
                            <span class="et-badge et-badge-warning">Dépassé</span>
                        {% endif %}
                    </li>
                {% else %}
                    <li class="et-list-empty">Aucun objectif.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{% if objectif_proche_depasse %}
<div class="et-card mt-4">
    <div class="et-card-header">Objectif le plus proche d'être dépassé</div>
    <div class="et-card-body">
        <p class="mb-0">
            <strong>{{ objectif_proche_depasse.objectif.typeEnergie ? objectif_proche_depasse.objectif.typeEnergie.libelle : '—' }}</strong>
            — Cible : {{ objectif_proche_depasse.objectif.valeurCible|number_format(0, ',', ' ') }} —
            Consommé : {{ objectif_proche_depasse.consommation_totale|number_format(0, ',', ' ') }} —
            Marge restante : <span class="et-badge et-badge-warning">{{ objectif_proche_depasse.marge|number_format(0, ',', ' ') }}</span>
        </p>
    </div>
</div>
{% endif %}

{% if top_logements|length > 0 %}
<div class="et-card mt-4">
    <div class="et-card-header">Top logements les plus consommateurs (ce mois)</div>
    <ul class="et-list-group">
        {% for row in top_logements %}
            <li class="et-list-item">
                <span>{{ row.logement.adresse }}</span>
                <strong>{{ row.total|number_format(0, ',', ' ') }} unités</strong>
            </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row g-4 mt-2">
    <div class="col-lg-6">
        <div class="et-card">
            <div class="et-card-header">Conso par type (ce mois)</div>
            <div class="et-card-body">
                <canvas id="chartConsoType" height="220"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="et-card">
            <div class="et-card-header">Évolution conso (30 derniers jours)</div>
            <div class="et-card-body">
                <canvas id="chartEvolution" height="220"></canvas>
            </div>
        </div>
    </div>
</div>

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
    var colors = ['#0d6efd', '#198754', '#fd7e14', '#6f42c1', '#d63384'];
    if (document.getElementById('chartConsoType')) {
        new Chart(document.getElementById('chartConsoType'), {
            type: 'bar',
            data: {
                labels: {{ chart_conso_type_labels|json_encode|raw }},
                datasets: [{ label: 'Consommation', data: {{ chart_conso_type_values|json_encode|raw }}, backgroundColor: colors }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
    if (document.getElementById('chartEvolution')) {
        new Chart(document.getElementById('chartEvolution'), {
            type: 'line',
            data: {
                labels: {{ chart_evolution_labels|json_encode|raw }},
                datasets: [{ label: 'Conso (unités)', data: {{ chart_evolution_values|json_encode|raw }}, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', fill: true, tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    }
})();
</script>
{% endblock %}
{% endblock %}
